<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pelacakan Kurir</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="min-h-screen flex flex-col">
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">Pelacak Kurir Lab</h1>
                <div class="flex items-center">
                    <span id="roleDisplay" class="text-sm font-semibold text-gray-600 mr-4"></span>
                    <button id="logoutButton" class="hidden bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Logout</button>
                </div>
            </div>
        </header>

        <main class="flex-grow container mx-auto p-4">
            <div id="loginContainer" class="max-w-md mx-auto mt-10 bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-center mb-6">Login</h2>
                <button id="loginButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    Login dengan Google
                </button>
                <p id="loginError" class="text-red-500 text-center mt-4"></p>
            </div>

            <div id="mainAppContainer" class="hidden">
                <!-- Admin/Superuser View -->
                <div id="adminView" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Courier Status -->
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-semibold mb-4 border-b pb-2">Status Kurir</h3>
                            <div id="courierStatusContainer" class="space-y-3"></div>
                        </div>
                        <!-- New Tasks -->
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-semibold mb-4 border-b pb-2">Tugas Baru</h3>
                            <div id="newTasksContainer" class="space-y-3"></div>
                        </div>
                    </div>
                </div>
                <!-- Courier View -->
                <div id="courierView" class="hidden bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">Tugas Anda</h3>
                    <div id="courierTasksContainer"></div>
                </div>
                 <!-- Client View -->
                <div id="clientView" class="hidden bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">Status Pengiriman Anda</h3>
                    <div id="clientTasksContainer"></div>
                </div>
                 <!-- Analyst View -->
                <div id="analystView" class="hidden bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">Penerimaan Sampel</h3>
                    <div id="analystTasksContainer"></div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, query, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- KONFIGURASI FIREBASE & AKSES PENGGUNA ---
        const firebaseConfig = {
            apiKey: "...",
            authDomain: "...",
            projectId: "...",
            storageBucket: "...",
            messagingSenderId: "...",
            appId: "..."
        };
        
        const ACCESS_CONFIG = {
            superusers: ['superuser@example.com'],
            admins: ['admin@example.com'],
            couriers: {
                'courier1@example.com': 'Budi',
                'courier2@example.com': 'Siti',
            },
            analysts: ['analyst@example.com'],
            clients: {
                'client1@example.com': 'clinic001',
                'client2@example.com': 'clinic002',
            }
        };

        const clinics = [
            { id: 'clinic001', name: 'Klinik Sehat' },
            { id: 'clinic002', name: 'Klinik Medika' },
        ];

        // --- INISIALISASI APLIKASI ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- FUNGSI BARU UNTUK MEMASTIKAN PROFIL KURIR ADA ---
        // Fungsi ini memeriksa apakah setiap kurir di ACCESS_CONFIG sudah memiliki
        // profil status di database. Jika tidak, maka akan dibuat secara otomatis.
        // Ini mengatasi masalah kurir tidak muncul jika databasenya masih kosong.
        async function initializeCourierProfiles() {
            const courierConfig = ACCESS_CONFIG.couriers;
            console.log("Memeriksa dan inisialisasi profil kurir...");

            for (const email in courierConfig) {
                const name = courierConfig[email];
                const courierRef = doc(db, "couriers", email); // Gunakan email sebagai ID unik

                const docSnap = await getDoc(courierRef);
                
                if (!docSnap.exists()) {
                    console.log(`Profil untuk ${name} (${email}) tidak ditemukan, sedang membuat...`);
                    try {
                        await setDoc(courierRef, {
                            name: name,
                            email: email,
                            status: 'Tersedia' // Status default
                        });
                        console.log(`Profil untuk ${name} berhasil dibuat.`);
                    } catch (e) {
                        console.error(`Gagal membuat profil untuk ${name}:`, e);
                    }
                }
            }
             console.log("Pemeriksaan profil kurir selesai.");
        }
        
        // --- STATE MANAGEMENT ---
        let currentUser = { role: null, name: null, clinicId: null, email: null };
        let unsubscribeTasks, unsubscribeCouriers;

        // --- AUTH & UI CONTROL ---
        function authorizeUser(user) {
            const email = user.email;
            let role = null, name = user.displayName, clinicId = null, roleText = '';
            
            if (ACCESS_CONFIG.superusers.includes(email)) { role = 'superuser'; roleText = 'Super User'; } 
            else if (ACCESS_CONFIG.admins.includes(email)) { role = 'admin'; roleText = 'Admin'; } 
            else if (ACCESS_CONFIG.couriers[email]) { role = 'kurir'; name = ACCESS_CONFIG.couriers[email]; roleText = `Kurir (${name})`; } 
            else if (ACCESS_CONFIG.analysts.includes(email)) { role = 'analis'; roleText = 'Analis Lab'; } 
            else if (ACCESS_CONFIG.clients[email]) { role = 'client'; clinicId = ACCESS_CONFIG.clients[email]; const clinic = clinics.find(c => c.id === clinicId); name = clinic.name; roleText = `Client (${name})`; }

            if (role) {
                currentUser = { role, name, clinicId, email };
                document.getElementById('roleDisplay').textContent = roleText;
                document.getElementById('loginContainer').classList.add('hidden');
                document.getElementById('mainAppContainer').classList.remove('hidden');
                document.getElementById('logoutButton').classList.remove('hidden');


                // Panggil inisialisasi jika admin atau superuser
                if (role === 'admin' || role === 'superuser') {
                    initializeCourierProfiles();
                }

                setupUIForRole();
                subscribeToData();
            } else {
                document.getElementById('loginError').textContent = 'Anda tidak memiliki akses.';
                logout();
            }
        }

        function setupUIForRole() {
            // Hide all views first
            ['adminView', 'courierView', 'clientView', 'analystView'].forEach(id => document.getElementById(id).classList.add('hidden'));

            if (currentUser.role === 'admin' || currentUser.role === 'superuser') {
                document.getElementById('adminView').classList.remove('hidden');
            } else if (currentUser.role === 'kurir') {
                document.getElementById('courierView').classList.remove('hidden');
            } else if (currentUser.role === 'client') {
                document.getElementById('clientView').classList.remove('hidden');
            } else if (currentUser.role === 'analis') {
                document.getElementById('analystView').classList.remove('hidden');
            }
        }
        
        async function logout() {
            if (unsubscribeTasks) unsubscribeTasks();
            if (unsubscribeCouriers) unsubscribeCouriers();
            await signOut(auth);
            currentUser = { role: null, name: null, clinicId: null, email: null };
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('mainAppContainer').classList.add('hidden');
            document.getElementById('logoutButton').classList.add('hidden');
            document.getElementById('roleDisplay').textContent = '';

        }

        // --- DATA HANDLING ---
        function subscribeToData() {
            // Unsubscribe from previous listeners if they exist
            if (unsubscribeTasks) unsubscribeTasks();
            if (unsubscribeCouriers) unsubscribeCouriers();

            const tasksCollection = collection(db, "tasks");
            unsubscribeTasks = onSnapshot(tasksCollection, (snapshot) => {
                const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTasks(tasks);
            });
            
            if (currentUser.role === 'admin' || currentUser.role === 'superuser') {
                 const couriersCollection = collection(db, "couriers");
                 unsubscribeCouriers = onSnapshot(couriersCollection, (snapshot) => {
                     const couriers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                     renderCourierStatus(couriers);
                 });
            }
        }

        // --- RENDERING ---
        function renderTasks(tasks) {
             if (currentUser.role === 'admin' || currentUser.role === 'superuser') {
                renderAdminTasks(tasks);
            } else if (currentUser.role === 'kurir') {
                renderCourierTasks(tasks.filter(t => t.courierEmail === currentUser.email));
            } else if (currentUser.role === 'client') {
                renderClientTasks(tasks.filter(t => t.clinicId === currentUser.clinicId));
            } else if (currentUser.role === 'analis') {
                renderAnalystTasks(tasks);
            }
        }
        
        function renderCourierStatus(couriers) {
            const container = document.getElementById('courierStatusContainer');
            container.innerHTML = '';
            couriers.forEach(c => {
                 container.innerHTML += `<div class="p-2 rounded-lg ${c.status === 'Tersedia' ? 'bg-green-100' : 'bg-yellow-100'}">${c.name}: ${c.status}</div>`;
            });
        }
        
        function renderAdminTasks(tasks) {
            const container = document.getElementById('newTasksContainer');
            container.innerHTML = '';
            const newTasks = tasks.filter(t => t.status === 'Baru');

            if (newTasks.length === 0) {
                 container.innerHTML = '<p class="text-gray-500">Tidak ada tugas baru.</p>';
                 return;
            }

            const availableCouriersQuery = query(collection(db, "couriers"));
             onSnapshot(availableCouriersQuery, (snapshot) => {
                const availableCouriers = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()})).filter(c => c.status === 'Tersedia');
                
                container.innerHTML = '';
                newTasks.forEach(task => {
                    let options = availableCouriers.map(c => `<option value="${c.email}">${c.name}</option>`).join('');
                    container.innerHTML += `
                        <div class="border p-4 rounded-lg">
                            <p><strong>Klinik:</strong> ${clinics.find(c => c.id === task.clinicId)?.name}</p>
                            <p><strong>Detail:</strong> ${task.details}</p>
                            <select id="courier-select-${task.id}" class="mt-2 p-2 border rounded w-full">
                                <option value="">Pilih Kurir</option>
                                ${options}
                            </select>
                            <button onclick="window.assignTask('${task.id}')" class="mt-2 bg-blue-500 text-white p-2 rounded w-full">Tugaskan</button>
                        </div>
                    `;
                });
            });
        }

        function renderCourierTasks(tasks) {
            const container = document.getElementById('courierTasksContainer');
            container.innerHTML = tasks.length ? '' : '<p>Tidak ada tugas untuk Anda saat ini.</p>';
            tasks.forEach(task => {
                container.innerHTML += `
                    <div class="border p-4 mb-2 rounded-lg">
                        <p><strong>Klinik:</strong> ${clinics.find(c => c.id === task.clinicId)?.name}</p>
                        <p><strong>Status:</strong> ${task.status}</p>
                        <p><strong>Detail:</strong> ${task.details}</p>
                        ${task.status === 'Ditugaskan' ? `<button onclick="window.updateTaskStatus('${task.id}', 'Diambil')" class="mt-2 bg-green-500 text-white p-2 rounded w-full">Tandai Diambil</button>` : ''}
                        ${task.status === 'Diambil' ? `<button onclick="window.updateTaskStatus('${task.id}', 'Diserahkan')" class="mt-2 bg-blue-500 text-white p-2 rounded w-full">Tandai Diserahkan</button>` : ''}
                    </div>
                `;
            });
        }
        
        function renderClientTasks(tasks) {
            const container = document.getElementById('clientTasksContainer');
            container.innerHTML = tasks.length ? '' : '<p>Tidak ada pengiriman untuk Anda saat ini.</p>';
             tasks.forEach(task => {
                container.innerHTML += `
                    <div class="border p-4 mb-2 rounded-lg">
                         <p><strong>Kurir:</strong> ${task.courierName || 'Belum ditugaskan'}</p>
                         <p><strong>Status:</strong> ${task.status}</p>
                         <p><strong>Detail:</strong> ${task.details}</p>
                    </div>
                `;
            });
        }

        function renderAnalystTasks(tasks) {
            const container = document.getElementById('analystTasksContainer');
            const submittedTasks = tasks.filter(t => t.status === 'Diserahkan');
            container.innerHTML = submittedTasks.length ? '' : '<p>Tidak ada sampel yang diterima.</p>';
            submittedTasks.forEach(task => {
                container.innerHTML += `
                     <div class="border p-4 mb-2 rounded-lg">
                         <p><strong>Dari Klinik:</strong> ${clinics.find(c => c.id === task.clinicId)?.name}</p>
                         <p><strong>Oleh Kurir:</strong> ${task.courierName}</p>
                         <p><strong>Detail:</strong> ${task.details}</p>
                         <button onclick="window.updateTaskStatus('${task.id}', 'Selesai')" class="mt-2 bg-purple-500 text-white p-2 rounded w-full">Tandai Selesai</button>
                     </div>
                `;
            });
        }

        // --- ACTIONS ---
        window.assignTask = async (taskId) => {
            const courierEmail = document.getElementById(`courier-select-${taskId}`).value;
            if (!courierEmail) { alert('Pilih kurir terlebih dahulu'); return; }

            const courierDoc = await getDoc(doc(db, "couriers", courierEmail));
            const courierName = courierDoc.data().name;

            const taskRef = doc(db, "tasks", taskId);
            const courierRef = doc(db, "couriers", courierEmail);

            await updateDoc(taskRef, { status: 'Ditugaskan', courierEmail, courierName });
            await updateDoc(courierRef, { status: 'Bertugas' });
        };

        window.updateTaskStatus = async (taskId, newStatus) => {
            const taskRef = doc(db, "tasks", taskId);
            await updateDoc(taskRef, { status: newStatus });

            if (newStatus === 'Diserahkan' || newStatus === 'Selesai') {
                const taskDoc = await getDoc(taskRef);
                const courierEmail = taskDoc.data().courierEmail;
                if (courierEmail) {
                     const courierRef = doc(db, "couriers", courierEmail);
                     await updateDoc(courierRef, { status: 'Tersedia' });
                }
            }
        };

        // --- EVENT LISTENERS ---
        document.getElementById('loginButton').addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(error => {
                console.error("Login gagal:", error);
                document.getElementById('loginError').textContent = "Login gagal. Silakan coba lagi.";
            });
        });
        
        document.getElementById('logoutButton').addEventListener('click', logout);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                authorizeUser(user);
            } else {
                console.log("Tidak ada pengguna yang login.");
            }
        });

    </script>
</body>
</html>

